# OpenLayers DjiGeozones

Create a Layer with DJI Geo Zones for an OpenLayer map. Also, add a Control to the map to select the levels and the drone to filter the zones.

The data is obtained directly from an undocumented DJI [API](https://www-api.dji.com/api/geo/areas). The official DJI Fly Safe Geo Zone Map that use the same data can be found [here](https://www.dji.com/flysafe/geo-map).

Tested with OpenLayers version 5 and 6.

### DISCLAIMER

Now days, DJI doesn't offer any API documentation, so future support and access to the data is uncertain. Further, the API endpoint has CORS restrictions, so all browsers requests must be reverse proxied.

## Examples

- [Basic usage](http://raw.githack.com/GastonZalba/ol-dji-geozones/master/examples/dji-geozones.html)
  - Create an OpenLayers map instance, and pass that map to the DJIGeozones constructor.

## Usage

```js
// Default values
let opt_options = {
  drone: 'spark', // {string} See drone parameter in the DJI API section
  zonesMode: 'total', // {string}
  country: 'US', // {string} See country parameter in the DJI API section
  levelsToDisplay: [2, 6, 1, 0, 3, 4, 7], // {array} Order is kept in the Control
  levelsActive: [2, 6, 1, 0, 3, 4, 7], // {array}
  control: true, // {boolean} Create or not the control
  targetControl: null // {HTMLElement | string} Specify a target if you want the control to be rendered outside of the map's viewport.
};

// SETTING A REVERSE PROXY TO AVOID CORS
// If you want a custom implementation, check out the repository (cors-anywhere)[https://github.com/Rob--W/cors-anywhere]
let url_proxy = 'https://cors-anywhere.herokuapp.com'; // You can use the public demo CORS Anywhere for testing

const djiGeozones = new DjiGeozones(map, url_proxy, opt_options);

// Instance methods
// This methods clean the loaded features and fires a new API request.
djiGeozones.setDrone(/* {String} */ 'spark');
djiGeozones.setCountry(/* {String} */ 'US'); // At the moment, this doesn't appear to affect the api response

djiGeozones.setLevels([1, 2, 3, 4, 6, 7]);
djiGeozones.addLevels(5);
djiGeozones.removeLevels(7);

djiGeozones.setControlVisible(/* {Boolean} */ true); // Show/hide the control

let layers = djiGeozones.getLayers(); // returns an array of ol/layer/Vector~VectorLayer instances
let layer = djiGeozones.getLayerByLevel(7); // returns an ol/layer/Vector~VectorLayer instance with the specefic level
```

## [DJI API](https://www-api.dji.com/api/geo/areas) - What we know

### Problems

The data returned by the API has some problems/strange behaviors:

The elements in _level 6_ (Altitude Zones, grey color) are returning from the api with _level 2_ in the properties (Restricted Zones, red color), and the elements in _level 4_ (Regulatory Restricted Zones, light blue color) with _level 7_ (Recommended Zones, green color).

This makes very messy the frontend, and make it impossible to filter these levels accordingly in each request. To avoid this problem, this module functions completely different from the official map: performss the API requests including all _levels_, distributing the results in differents layers according to each level.

See [DjiApi API](#DjiApi) for parameters and details.

## Changelog

See [CHANGELOG](./CHANGELOG.md) for details of changes in each release.

## Install

### Browser

#### JS

Load `ol-dji-geozones.js` after OpenLayers. Dji Geozone is available as `DjiGeozones`.

```HTML
<script src="https://unpkg.com/ol-dji-geozones@1.0.0"></script>
```

#### CSS

```HTML
<link rel="stylesheet" href="https://unpkg.com/ol-dji-geozones@1.0.0/dist/ol-dji-geozones.css" />
```

### Parcel, Webpack, etc.

NPM package: [ol-dji-geozones](https://www.npmjs.com/package/ol-dji-geozones).

#### JS

Install the package via `npm`

    npm install ol-dji-geozones

#### CSS

The CSS file `ol-dji-geozones.css` can be found in `./node_modules/ol-dji-geozones/dist`

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

- [DjiGeozones](#djigeozones)
  - [Parameters](#parameters)
  - [getApiGeoData](#getapigeodata)
    - [Parameters](#parameters-1)
  - [setControlVisible](#setcontrolvisible)
    - [Parameters](#parameters-2)
  - [getLayers](#getlayers)
  - [getLayerByLevel](#getlayerbylevel)
    - [Parameters](#parameters-3)
  - [getLevelsParams](#getlevelsparams)
  - [getLevelParamsById](#getlevelparamsbyid)
    - [Parameters](#parameters-4)
  - [setLevels](#setlevels)
    - [Parameters](#parameters-5)
  - [addLevels](#addlevels)
    - [Parameters](#parameters-6)
  - [removeLevels](#removelevels)
    - [Parameters](#parameters-7)
  - [getGeozoneTypes](#getgeozonetypes)
  - [getGeozoneTypeById](#getgeozonetypebyid)
    - [Parameters](#parameters-8)
  - [getDrones](#getdrones)
  - [colorWithAlpha](#colorwithalpha)
    - [Parameters](#parameters-9)
- [DjiApi](#djiapi)
  - [level](#level)
  - [drone](#drone)
  - [country](#country)
  - [zones_mode](#zones_mode)
  - [lng](#lng)
  - [lat](#lat)
  - [search_radius](#search_radius)
- [Drone](#drone-1)
- [DroneList](#dronelist)
- [LevelParams](#levelparams)
- [LevelTexts](#leveltexts)
- [TypeTexts](#typetexts)
- [TypesTextsList](#typestextslist)
- [LevelsParamsList](#levelsparamslist)
- [Options](#options)
  - [zonesMode](#zonesmode)
  - [country](#country-1)
  - [levelsToDisplay](#levelstodisplay)
  - [levelsActive](#levelsactive)
  - [levelParams](#levelparams-1)
  - [dronesList](#droneslist)
  - [extent](#extent)
  - [showPanel](#showpanel)
  - [targetPanel](#targetpanel)
  - [loadingElement](#loadingelement)
  - [clickEvent](#clickevent)
  - [language](#language)
  - [typesTexts](#typestexts)
  - [levelsTexts](#levelstexts)

### DjiGeozones

OpenLayers DJI Geozone, creates multiples VectorLayers to
display interactives DJI Geo Zones on the map, requesting the
data on the fly to an DJI API.

Also, add a Control to select levels of interest and drone to filter the results.

#### Parameters

- `map` **[PluggableMap](https://openlayers.org/en/latest/apidoc/module-ol_PluggableMap-PluggableMap.html)** Instance of the created map
- `url_proxy` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Proxy's url to avoid CORS protection in the API.
- `opt_options` **[Options](#options)?** DjiGeozones options, see [DjiGeozones Options](#options) for more details.

#### getApiGeoData

Controller for the API rquests.

##### Parameters

- `typeApiRequest` **(`"areas"` \| `"info"`)**
- `latLng` **{lat: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number), lng: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)}**

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;any>**

#### setControlVisible

Show or hides the control

##### Parameters

- `visible` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Returns **void**

#### getLayers

Get all the layers

Returns **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;VectorLayer>**

#### getLayerByLevel

Get the layer acordding the level

##### Parameters

- `level` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)**

Returns **VectorLayer**

#### getLevelsParams

Get the parameters from all the levels

Returns **[LevelsParamsList](#levelsparamslist)**

#### getLevelParamsById

Get the level parameters, like color, icon, and description

##### Parameters

- `id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** (optional, default `null`)

Returns **[LevelParams](#levelparams)**

#### setLevels

Replace the active levels with this values

##### Parameters

- `levels` **([Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)> | [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number))**
- `refresh` If true, refresh the view and show the levels (optional, default `true`)

Returns **void**

#### addLevels

Add the level/s to the view

##### Parameters

- `levels` **([Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)> | [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number))**
- `refresh` If true, refresh the view and show the actived levels (optional, default `true`)

Returns **void**

#### removeLevels

Remove the level/s from the view

##### Parameters

- `levels` **([Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)> | [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number))**
- `refresh` If true, refresh the view and show the actived levels (optional, default `true`)

Returns **void**

#### getGeozoneTypes

Returns **[TypesTextsList](#typestextslist)**

#### getGeozoneTypeById

##### Parameters

- `id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** (optional, default `null`)

Returns **[TypeTexts](#typetexts)**

#### getDrones

Get a list with all the supported Drones

Returns **[DroneList](#dronelist)**

#### colorWithAlpha

**_[static]_** - Generate an RGBA color from an hexadecimal

Adapted from <https://stackoverflow.com/questions/28004153>

##### Parameters

- `color` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Hexadeciaml color
- `alpha` Opacity (optional, default `1`)

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)**

### DjiApi

**_[interface]_** - Dji Api Parameters

#### level

- `2` - Restricted Zones
- `6` - Altitude Zones
- `1` - Authorization Zones
- `0` - Warning Zones
- `3` - Enhanced Warning Zones
- `9` - Densely Populated Area **NOT SUPPORTED - This level exists in the oficial Geo Zone Map, but this data is not provided by the api. On the other hand, now days this level is apparently valid only for Japan and China**
- `4` - Regulatory Restricted Zones
- `7` - Recommended Zones
- `8` - Approved Zones for Light UAVs(China) **Only valid for China**
- `5` - Recommended Zones (2) **Apparently this level is only valid for Japan**

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>

#### drone

- `mavic-mini` (Mavic Mini)
- `mavic-2-enterprise` (Mavic 2 Enterprise)
- `mavic-2` (Mavic 2)
- `mavic-air` (Mavic Air)
- `mavic-air-2` (Mavic Air 2)
- `mavic-pro` (Mavic Pro)
- `spark` (Spark)
- `phantom-4-pro` (Phantom 4 Pro)
- `phantom-4-advanced` (Phantom 4 Advanced)
- `phantom-4` (Phantom 4)
- `phantom-4-rtk` (Phantom 4 RTK)
- `phantom-4-multispectral` (Phantom 4 Multispectral)
- `phantom-3-pro` (Phantom 3 Pro
- `phantom-3-advanced` (Phantom 3 Advanced)
- `phantom-3-standard` (Phantom 3 Standard)
- `phantom-3-4K` (Phantom 3 4K)
- `phantom-3-se` (Phantom 3 SE)
- `inspire-2` (Inspire 2)
- `inspire-1-series` (Inspire 1 Series)
- `m200-series` (M200 Series)
- `m300-series` (M300 Series)
- `m600-series` (M600 Series)
- `m100` (M100)
- `mg1p` (MG 1S/1A/1P/1P RTK/T10/T16/T20/T30)
- `dji-mini-2` (DJI Mini 2)

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### country

Apparently doesn't affects the response of the api

- `US`
- `AR`
- _etc_ ([See the supported list](https://www.dji.com/flysafe/geo-map))

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### zones_mode

Apparently only accepts 'total'

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### lng

Map View center point Longitude

Type: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)

#### lat

Map View center point Latitude

Type: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)

#### search_radius

Radius of the current view of the map

Type: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)

### Drone

**_[interface]_** - Drone

### DroneList

**_[interface]_** - Parameter specified when creating a DjiGeozones.
By default, this use the sames values of the official API.
Also, this this can be useful to allow translations or display customs texts.

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Drone](#drone)>

### LevelParams

**_[interface]_** - DjiGeozones levels parameters specified when creating a DjiGeozones

### LevelTexts

**_[interface]_** - DjiGeozones levels text for translations or customs texts

### TypeTexts

**_[interface]_** - Geozone Type allows by the API

### TypesTextsList

**_[interface]_** - Parameter with the avalible Geozones types specified when creating a DjiGeozones.
By default, this use the sames values of the official API.
Also, this this can be useful to allow translations or display customs texts.

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[TypeTexts](#typetexts)>

### LevelsParamsList

**_[interface]_** - Parameter specified when creating a DjiGeozones.
Provide the colors, icons and more from each level.

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[LevelParams](#levelparams)>

### Options

**_[interface]_** - DjiGeozones Options specified when creating a DjiGeozones

Default values:

```javascript
{
  drone: 'spark', // See parameter in the DJI API section
  zonesMode: 'total', // See parameter in the DJI API section
  country: 'US', // See parameter in the DJI API section
  levelsToDisplay: [2, 6, 1, 0, 3, 4, 7],
  levelsActive: [2, 6, 1, 0, 3, 4, 7],
  showPanel: true,
  targetControl: null,
  extent: null,
  loadingElement: '<div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>'
}
```

#### zonesMode

zonesMode to be used in the API request

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### country

Country identifier to be used in the API request

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### levelsToDisplay

Geozone Levels to be shown in the Control

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>

#### levelsActive

Geozone Levels to be activated in the Control and the API request

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>

#### levelParams

Controller labels, names, icons and color for each level

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[LevelParams](#levelparams)>

#### dronesList

Supported drone list

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Drone](#drone)>

#### extent

The bounding extent for layer rendering.
The layers will not be rendered outside of this extent.

Type: Extent

#### showPanel

Display or hide the panel controller on the map

Type: [boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)

#### targetPanel

Specify a target if you want the control to be rendered outside of the map's viewport.

Type: ([HTMLElement](https://developer.mozilla.org/docs/Web/HTML/Element) \| [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String))

#### loadingElement

Loading element to be shown in the Controller on loading API data

Type: [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)

#### clickEvent

Click event to show PopUp information

Type: (`"singleclick"` \| `"dblclick"`)

#### language

Language

Type: (`"en"` \| `"es"`)

#### typesTexts

Supported

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[TypeTexts](#typetexts)>

#### levelsTexts

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[LevelTexts](#leveltexts)>

## TODO

Add multiples languages presets.

## License

MIT (c) Gastón Zalba.
